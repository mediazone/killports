name: Build and Release KillPorts

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.1, v2.1.0, etc.
  workflow_dispatch:  # Allows manual triggering
    inputs:
      version:
        description: 'Version number (e.g., v1.0.1)'
        required: true
        default: 'v1.0.0'

env:
  APP_NAME: "KillPorts"
  SCHEME_NAME: "KillPorts"
  BUNDLE_ID: "nl.mediazone.killports"
  
jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Get version from tag or input
      id: version
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=${{ github.event.inputs.version }}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        
    - name: Update version in project
      run: |
        # Update Info.plist with new version
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.VERSION_NUMBER }}" "$APP_NAME/Info.plist" || true
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.version.outputs.VERSION_NUMBER }}" "$APP_NAME/Info.plist" || true
        
        # Update project.pbxproj if needed
        if [ -f "$APP_NAME.xcodeproj/project.pbxproj" ]; then
          sed -i '' "s/MARKETING_VERSION = .*/MARKETING_VERSION = ${{ steps.version.outputs.VERSION_NUMBER }};/g" "$APP_NAME.xcodeproj/project.pbxproj"
          sed -i '' "s/CURRENT_PROJECT_VERSION = .*/CURRENT_PROJECT_VERSION = ${{ steps.version.outputs.VERSION_NUMBER }};/g" "$APP_NAME.xcodeproj/project.pbxproj"
        fi
        
    - name: Import Code-Signing Certificates
      uses: Apple-Actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
        p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
        
    - name: Install the provisioning profile
      env:
        PROVISIONING_CERTIFICATE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
      run: |
        if [ ! -z "$PROVISIONING_CERTIFICATE_BASE64" ]; then
          PP_PATH=$RUNNER_TEMP/build_pp.provisionprofile
          echo -n "$PROVISIONING_CERTIFICATE_BASE64" | base64 --decode --output $PP_PATH
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles
        fi
        
    - name: Build app
      run: |
        echo "üî® Building KillPorts for macOS..."
        
        # Build the app
        xcodebuild -scheme "$SCHEME_NAME" \
                   -configuration Release \
                   -archivePath "$RUNNER_TEMP/$APP_NAME.xcarchive" \
                   -destination "generic/platform=macOS" \
                   archive \
                   CODE_SIGN_IDENTITY="Developer ID Application" \
                   PROVISIONING_PROFILE="" \
                   CODE_SIGN_STYLE=Manual
                   
        echo "‚úÖ Build completed successfully"
        
    - name: Export app
      run: |
        echo "üì¶ Exporting KillPorts app..."
        
        # Create export options plist
        cat > "$RUNNER_TEMP/ExportOptions.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>developer-id</string>
            <key>teamID</key>
            <string>\${{ secrets.APPLE_TEAM_ID }}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # Export the archive
        xcodebuild -exportArchive \
                   -archivePath "$RUNNER_TEMP/$APP_NAME.xcarchive" \
                   -exportPath "$RUNNER_TEMP/export" \
                   -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist"
                   
        echo "‚úÖ Export completed successfully"
        
    - name: Notarize app
      env:
        NOTARIZATION_USERNAME: ${{ secrets.NOTARIZATION_USERNAME }}
        NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        echo "üîê Notarizing KillPorts with Apple..."
        
        # Find the exported app
        APP_PATH=$(find "$RUNNER_TEMP/export" -name "*.app" -type d | head -n 1)
        echo "App path: $APP_PATH"
        
        # Create a zip for notarization
        NOTARIZE_ZIP="$RUNNER_TEMP/$APP_NAME-${{ steps.version.outputs.VERSION }}.zip"
        cd "$(dirname "$APP_PATH")"
        zip -r "$NOTARIZE_ZIP" "$(basename "$APP_PATH")"
        
        # Submit for notarization
        echo "Submitting to Apple for notarization..."
        xcrun notarytool submit "$NOTARIZE_ZIP" \
                               --apple-id "$NOTARIZATION_USERNAME" \
                               --password "$NOTARIZATION_PASSWORD" \
                               --team-id "$APPLE_TEAM_ID" \
                               --wait
                               
        echo "‚úÖ Notarization completed successfully"
        
    - name: Create installer package
      run: |
        echo "üì¶ Creating installer package..."
        
        # Find the exported app
        APP_PATH=$(find "$RUNNER_TEMP/export" -name "*.app" -type d | head -n 1)
        PKG_PATH="$RUNNER_TEMP/$APP_NAME-${{ steps.version.outputs.VERSION }}.pkg"
        
        # Create the installer package
        productbuild --component "$APP_PATH" /Applications \
                     --sign "Developer ID Installer" \
                     "$PKG_PATH"
                     
        # Verify the package
        echo "Package created at: $PKG_PATH"
        ls -la "$PKG_PATH"
        
        echo "PKG_PATH=$PKG_PATH" >> $GITHUB_ENV
        
        echo "‚úÖ Installer package created successfully"
        
    - name: Calculate checksums
      run: |
        echo "üî¢ Calculating checksums..."
        cd "$RUNNER_TEMP"
        
        # Calculate SHA256
        shasum -a 256 "$APP_NAME-${{ steps.version.outputs.VERSION }}.pkg" > checksums.txt
        
        echo "Checksums:"
        cat checksums.txt
        
    - name: Create Release Notes
      id: release_notes
      run: |
        cat > "$RUNNER_TEMP/release_notes.md" << EOF
        # KillPorts ${{ steps.version.outputs.VERSION }}
        
        ## üöÄ What's New
        
        - Improved port management functionality
        - Enhanced macOS compatibility  
        - Performance optimizations
        - Bug fixes and stability improvements
        
        ## üìã System Requirements
        
        - **macOS**: 13.0 or later
        - **Architecture**: Apple Silicon (M1/M2/M3) and Intel
        - **Size**: $(ls -lh "$PKG_PATH" | awk '{print $5}')
        
        ## üõ°Ô∏è Security
        
        - ‚úÖ **Code Signed** with Developer ID
        - ‚úÖ **Notarized** by Apple
        - ‚úÖ **Malware Scanned**
        
        ## üîß Installation
        
        1. Download \`KillPorts-${{ steps.version.outputs.VERSION }}.pkg\`
        2. Double-click to install
        3. Launch from Applications folder
        4. Grant necessary permissions when prompted
        
        ## üìù Checksums
        
        \`\`\`
        $(cat "$RUNNER_TEMP/checksums.txt")
        \`\`\`
        
        ---
        
        ü§ñ *This release was automatically built and deployed via GitHub Actions*
        EOF
        
        echo "RELEASE_NOTES_PATH=$RUNNER_TEMP/release_notes.md" >> $GITHUB_ENV
        
    - name: Generate Legal Pages
      run: |
        echo "üìã Generating legal documentation..."
        
        # Create Terms of Use
        cat > "$RUNNER_TEMP/terms.html" << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Terms of Use - KillPorts</title>
            <meta name="description" content="Terms of Use for KillPorts - Free macOS Port Management Tool">
            <link rel="canonical" href="https://killports.com/terms.html">
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; margin: 0; padding: 20px; background: #0A0A0A; color: #FFFFFF; }
                .container { max-width: 800px; margin: 0 auto; }
                h1 { color: #FF4444; border-bottom: 2px solid #FF4444; padding-bottom: 10px; }
                h2 { color: #FF6666; margin-top: 30px; }
                a { color: #FF4444; }
                .back-link { background: #FF4444; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-bottom: 20px; }
            </style>
        </head>
        <body>
            <div class="container">
                <a href="/" class="back-link">‚Üê Back to KillPorts</a>
                
                <h1>Terms of Use</h1>
                <p><strong>Last Updated:</strong> $(date +"%B %d, %Y")</p>
                
                <h2>1. Acceptance of Terms</h2>
                <p>By downloading, installing, or using KillPorts software, you agree to be bound by these Terms of Use. If you do not agree to these terms, do not use the software.</p>
                
                <h2>2. Description of Service</h2>
                <p>KillPorts is a free macOS application that provides network port management functionality for developers. The software allows users to identify and terminate network processes through a MenuBar interface.</p>
                
                <h2>3. License Grant</h2>
                <p>KillPorts is provided free of charge under an open source license. You are granted a non-exclusive, non-transferable license to use the software for personal and commercial purposes.</p>
                
                <h2>4. User Responsibilities</h2>
                <ul>
                    <li>Use the software responsibly and in accordance with its intended purpose</li>
                    <li>Do not use the software to terminate critical system processes</li>
                    <li>Ensure you have proper administrative privileges before using port management features</li>
                    <li>Back up important work before terminating development processes</li>
                </ul>
                
                <h2>5. Disclaimer of Warranties</h2>
                <p>KillPorts is provided "AS IS" without warranty of any kind. The developers make no representations or warranties regarding the software's functionality, reliability, or suitability for any particular purpose.</p>
                
                <h2>6. Limitation of Liability</h2>
                <p>In no event shall the developers be liable for any direct, indirect, incidental, special, or consequential damages arising from the use or inability to use the software.</p>
                
                <h2>7. Updates and Modifications</h2>
                <p>These terms may be updated from time to time. Continued use of the software after any such changes constitutes acceptance of the new terms.</p>
                
                <h2>8. Contact Information</h2>
                <p>For questions about these terms, please contact: <a href="mailto:info@mediazone.nl">info@mediazone.nl</a></p>
                
                <h2>9. Governing Law</h2>
                <p>These terms are governed by the laws of the Netherlands. Any disputes shall be resolved in the courts of the Netherlands.</p>
            </div>
        </body>
        </html>
        EOF
        
        # Create Privacy Policy
        cat > "$RUNNER_TEMP/privacy.html" << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Privacy Policy - KillPorts</title>
            <meta name="description" content="Privacy Policy for KillPorts - We respect your privacy and collect minimal data">
            <link rel="canonical" href="https://killports.com/privacy.html">
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; margin: 0; padding: 20px; background: #0A0A0A; color: #FFFFFF; }
                .container { max-width: 800px; margin: 0 auto; }
                h1 { color: #FF4444; border-bottom: 2px solid #FF4444; padding-bottom: 10px; }
                h2 { color: #FF6666; margin-top: 30px; }
                a { color: #FF4444; }
                .back-link { background: #FF4444; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-bottom: 20px; }
                .highlight { background: rgba(255, 68, 68, 0.1); padding: 15px; border-left: 3px solid #FF4444; margin: 20px 0; }
            </style>
        </head>
        <body>
            <div class="container">
                <a href="/" class="back-link">‚Üê Back to KillPorts</a>
                
                <h1>Privacy Policy</h1>
                <p><strong>Last Updated:</strong> $(date +"%B %d, %Y")</p>
                
                <div class="highlight">
                    <strong>Privacy First:</strong> KillPorts is designed with privacy in mind. We collect minimal data and never track your personal development work.
                </div>
                
                <h2>1. Information We Collect</h2>
                <h3>Application Usage</h3>
                <ul>
                    <li><strong>No Personal Data:</strong> KillPorts does not collect personal information</li>
                    <li><strong>No Process Monitoring:</strong> We do not track which processes you terminate</li>
                    <li><strong>No Network Monitoring:</strong> We do not monitor your network traffic or development servers</li>
                    <li><strong>No File Access:</strong> The app only accesses system process information necessary for port management</li>
                </ul>
                
                <h3>Download Analytics</h3>
                <ul>
                    <li>Download counts from GitHub (public information)</li>
                    <li>General geographic regions (country-level only)</li>
                    <li>No individual user tracking or identification</li>
                </ul>
                
                <h2>2. How We Use Information</h2>
                <ul>
                    <li>Improve software functionality based on general usage patterns</li>
                    <li>Provide technical support when requested</li>
                    <li>Maintain and update the application</li>
                </ul>
                
                <h2>3. Information Sharing</h2>
                <p>We do not sell, trade, or share any user information with third parties. KillPorts operates entirely locally on your macOS system.</p>
                
                <h2>4. Data Storage</h2>
                <ul>
                    <li>All process management occurs locally on your device</li>
                    <li>No data is transmitted to external servers during normal operation</li>
                    <li>Application preferences are stored locally in macOS system directories</li>
                </ul>
                
                <h2>5. Third-Party Services</h2>
                <ul>
                    <li><strong>GitHub:</strong> Software distribution and updates (subject to GitHub's privacy policy)</li>
                    <li><strong>Apple:</strong> Code signing and notarization (subject to Apple's privacy policy)</li>
                </ul>
                
                <h2>6. Your Rights</h2>
                <ul>
                    <li>Right to use the software without data collection</li>
                    <li>Right to uninstall the software at any time</li>
                    <li>Right to contact us with privacy concerns</li>
                </ul>
                
                <h2>7. Security</h2>
                <p>KillPorts is Apple notarized and code signed. The application follows macOS security guidelines and requires appropriate permissions for process management.</p>
                
                <h2>8. Children's Privacy</h2>
                <p>KillPorts is intended for developers and does not knowingly collect information from children under 13.</p>
                
                <h2>9. Changes to Privacy Policy</h2>
                <p>We may update this privacy policy from time to time. Changes will be posted on our website with an updated date.</p>
                
                <h2>10. Contact Us</h2>
                <p>For privacy-related questions or concerns:</p>
                <ul>
                    <li>Email: <a href="mailto:info@mediazone.nl">info@mediazone.nl</a></li>
                    <li>GitHub: <a href="https://github.com/mediazone/killports/issues">Report Issues</a></li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Create License Page
        cat > "$RUNNER_TEMP/license.html" << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>License - KillPorts</title>
            <meta name="description" content="Open Source License for KillPorts - Free macOS Port Management Tool">
            <link rel="canonical" href="https://killports.com/license.html">
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; margin: 0; padding: 20px; background: #0A0A0A; color: #FFFFFF; }
                .container { max-width: 800px; margin: 0 auto; }
                h1 { color: #FF4444; border-bottom: 2px solid #FF4444; padding-bottom: 10px; }
                h2 { color: #FF6666; margin-top: 30px; }
                a { color: #FF4444; }
                .back-link { background: #FF4444; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-bottom: 20px; }
                .license-text { background: #111; padding: 20px; border-left: 3px solid #FF4444; font-family: 'Monaco', 'Menlo', monospace; font-size: 14px; }
                .highlight { background: rgba(255, 68, 68, 0.1); padding: 15px; border-left: 3px solid #FF4444; margin: 20px 0; }
            </style>
        </head>
        <body>
            <div class="container">
                <a href="/" class="back-link">‚Üê Back to KillPorts</a>
                
                <h1>Open Source License</h1>
                <p><strong>Version:</strong> KillPorts ${{ steps.version.outputs.VERSION }}</p>
                <p><strong>Release Date:</strong> $(date +"%B %d, %Y")</p>
                
                <div class="highlight">
                    <strong>Free and Open Source:</strong> KillPorts is released under the MIT License, giving you freedom to use, modify, and distribute the software.
                </div>
                
                <h2>MIT License</h2>
                
                <div class="license-text">
        Copyright (c) $(date +"%Y") Ron Koldeweid, Mediazone
        
        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:
        
        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.
        
        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
                </div>
                
                <h2>What This Means</h2>
                <ul>
                    <li><strong>‚úÖ Commercial Use:</strong> You can use KillPorts in commercial projects</li>
                    <li><strong>‚úÖ Modification:</strong> You can modify the source code for your needs</li>
                    <li><strong>‚úÖ Distribution:</strong> You can distribute copies of the software</li>
                    <li><strong>‚úÖ Private Use:</strong> You can use the software privately</li>
                    <li><strong>‚ö†Ô∏è Liability:</strong> Software is provided "as is" without warranty</li>
                    <li><strong>üìã License Notice:</strong> Include the license notice in distributions</li>
                </ul>
                
                <h2>Third-Party Components</h2>
                <p>KillPorts may include third-party libraries and components. Each component retains its original license:</p>
                <ul>
                    <li>macOS System Frameworks (Apple's Software License Agreement)</li>
                    <li>Swift Runtime (Apache License 2.0)</li>
                </ul>
                
                <h2>Source Code</h2>
                <p>The complete source code for KillPorts is available on GitHub:</p>
                <p><a href="https://github.com/mediazone/killports">https://github.com/mediazone/killports</a></p>
                
                <h2>Contributing</h2>
                <p>We welcome contributions! By contributing to KillPorts, you agree that your contributions will be licensed under the same MIT License.</p>
                
                <h2>Questions</h2>
                <p>For questions about licensing:</p>
                <ul>
                    <li>Email: <a href="mailto:info@mediazone.nl">info@mediazone.nl</a></li>
                    <li>GitHub: <a href="https://github.com/mediazone/killports">KillPorts Repository</a></li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        echo "‚úÖ Legal pages generated successfully"
        
    - name: Create Release in Public Repository
      env:
        GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
      run: |
        echo "üöÄ Creating release in public repository..."
        
        # Set up git for the public repo
        git config --global user.name "KillPorts Release Bot"
        git config --global user.email "noreply@mediazone.nl"
        
        # Clone public repository
        git clone https://x-access-token:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/mediazone/killports.git public-repo
        cd public-repo
        
        # Create and push tag
        git tag ${{ steps.version.outputs.VERSION }}
        git push origin ${{ steps.version.outputs.VERSION }}
        
        # Create the release using GitHub CLI
        gh release create ${{ steps.version.outputs.VERSION }} \
           "$PKG_PATH" \
           "$RUNNER_TEMP/checksums.txt" \
           --title "KillPorts ${{ steps.version.outputs.VERSION }}" \
           --notes-file "$RELEASE_NOTES_PATH" \
           --repo mediazone/killports
           
        echo "‚úÖ Release created successfully in public repository"
        
        # Copy legal pages to website
        echo "üìã Updating legal pages..."
        cp "$RUNNER_TEMP/terms.html" .
        cp "$RUNNER_TEMP/privacy.html" .
        cp "$RUNNER_TEMP/license.html" .
        
        # Commit legal pages if they changed
        if ! git diff --quiet terms.html privacy.html license.html 2>/dev/null; then
            git add terms.html privacy.html license.html
            git commit -m "üìã Auto-update legal pages for ${{ steps.version.outputs.VERSION }}

- Updated Terms of Use with current date
- Updated Privacy Policy with current date  
- Updated License with current version and date

ü§ñ Generated automatically during release process"
            git push origin main
            echo "‚úÖ Legal pages updated and committed"
        else
            echo "‚ÑπÔ∏è  Legal pages unchanged"
        fi
        
    - name: Update website version references
      env:
        GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
      run: |
        echo "üåê Updating website version references..."
        cd public-repo
        
        # Update any hardcoded version references in website files
        if [ -f "index.html" ]; then
          # Update download links to point to new version
          sed -i '' "s/KillPorts-v[0-9]*\.[0-9]*\.[0-9]*/KillPorts-${{ steps.version.outputs.VERSION }}/g" index.html
          
          # Update version numbers in text
          sed -i '' "s/v[0-9]*\.[0-9]*\.[0-9]*/${{ steps.version.outputs.VERSION }}/g" index.html
          
          # Commit changes if any
          if ! git diff --quiet; then
            git add index.html
            git commit -m "ü§ñ Auto-update website for ${{ steps.version.outputs.VERSION }}"
            git push origin main
            echo "‚úÖ Website updated with new version"
          else
            echo "‚ÑπÔ∏è  No website updates needed (dynamic versioning in use)"
          fi
        fi
        
    - name: Notify completion
      run: |
        echo "üéâ KillPorts ${{ steps.version.outputs.VERSION }} has been successfully built and released!"
        echo ""
        echo "üì¶ Package: $APP_NAME-${{ steps.version.outputs.VERSION }}.pkg"
        echo "üîó Public Release: https://github.com/mediazone/killports/releases/tag/${{ steps.version.outputs.VERSION }}"
        echo "üåê Website: https://killports.com (will auto-update)"
        echo ""
        echo "‚úÖ The website will automatically detect and display this new version!"