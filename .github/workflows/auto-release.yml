name: 🚀 Auto Website Update on Push

on:
  push:
    branches: [ main ]
    paths:
      - 'RELEASE.md'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-release:
    name: 📦 Create Release
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4

    - name: 🏷️ Set Version
      id: version
      run: |
        # Extract version from RELEASE.md if it exists
        if [ -f RELEASE.md ]; then
          VERSION=$(grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' RELEASE.md | head -1 | sed 's/v//')
        fi
        
        # Fallback to default version if not found
        if [ -z "$VERSION" ]; then
          VERSION="1.0.0"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version detected: $VERSION"


    - name: 📝 Update Website Version
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Update version in index.html
        sed -i "s/Download v[0-9]\+\.[0-9]\+\.[0-9]\+/Download v$VERSION/g" index.html || echo "No version in index.html"
        sed -i "s/KillPorts v[0-9]\+\.[0-9]\+\.[0-9]\+/KillPorts v$VERSION/g" index.html || echo "No KillPorts version in index.html"
        # Update download URLs to use specific version path (works with actual GitHub releases)
        sed -i "s|https://github.com/mediazone/killports/releases/[^\"]*\.pkg|https://github.com/mediazone/killports/releases/download/v$VERSION/KillPorts-v$VERSION.pkg|g" index.html || echo "No download URL in index.html"
        
        # Update README.md
        sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$VERSION/g" README.md || echo "No version in README.md"
        # Update download URLs in README to use specific version path
        sed -i "s|https://github.com/mediazone/killports/releases/[^)]*\.pkg|https://github.com/mediazone/killports/releases/download/v$VERSION/KillPorts-v$VERSION.pkg|g" README.md || echo "No download URL in README.md"
        
        echo "✅ Updated website to version $VERSION"

    - name: 📝 Update CHANGELOG
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Create updated changelog
        cat > temp_changelog.md << EOF
        # Changelog
        
        All notable changes to KillPorts will be documented in this file.
        
        ## [$VERSION] - $(date +%Y-%m-%d)
        
        ### Added
        - Automated release with notarized installer
        - Robot MenuBar icon
        - Fast port termination functionality
        - Apple notarized and code signed package
        
        EOF
        
        # Append existing changelog if it exists
        if [ -f CHANGELOG.md ]; then
          # Skip first few lines of existing changelog
          tail -n +5 CHANGELOG.md >> temp_changelog.md 2>/dev/null || echo ""
        fi
        
        mv temp_changelog.md CHANGELOG.md
        echo "✅ Updated CHANGELOG.md"

    - name: 📝 Commit Website Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "KillPorts Release Bot"
        git add index.html README.md CHANGELOG.md
        
        if ! git diff --staged --quiet; then
          git commit -m "🔄 Auto-update website to v${{ steps.version.outputs.version }}
          
          ✨ Automated updates:
          - Updated download links to v${{ steps.version.outputs.version }}
          - Refreshed version numbers across website
          - Updated changelog with new release info
          
          📦 Package: ${{ steps.pkg.outputs.pkg_file }} (${{ steps.pkg.outputs.pkg_size }})"
          git push
        else
          echo "No website changes to commit"
        fi

    - name: 🎉 Website Update Complete
      run: |
        echo "🎉 Successfully created KillPorts v${{ steps.version.outputs.version }}!"
        echo "🌐 Website: https://mediazone.github.io/killports/"
        echo "📦 Download: https://github.com/mediazone/killports/releases/tag/v${{ steps.version.outputs.version }}"
        echo "🤖 Users can now download the notarized installer!"